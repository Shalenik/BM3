---
title: "Usage Example - New York"
author: "BFACT Package"
date: "2026-01-09"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Usage Example - New York}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(BFACT)
library(ggplot2)
library(ncdf4)
```

# Introduction

This vignette demonstrates how to load and analyze New York temperature anomaly data from a NetCDF file included in the BFACT package.

# Load Example Data

```{r load-data}
# Load NetCDF file containing New York temperature anomalies
nc_file <- system.file("data", "NewYork_temperature_anomalies_JJA_all_models_1961-1990baseline.nc", package = "BFACT")
nc <- nc_open(nc_file)

# Extract temperature data: dimensions are [lon, lat, year, scenario, model]
temp_data <- ncvar_get(nc, "temperature")
years <- ncvar_get(nc, "year")

# Spatially average across lon and lat for each year, scenario, and model
# Result: [year, scenario, model] = [251, 3, 22]
temp_avg <- apply(temp_data, c(3, 4, 5), mean, na.rm = TRUE)

# Extract data for each SSP scenario
# Scenarios: 1=SSP1-2.6, 2=SSP2-4.5, 3=SSP5-8.5
climate_models <- list(
  z126c = temp_avg[, 1, , ],
  z245c = temp_avg[, 2, , ],
  z585c = temp_avg[, 3, , ]
)

# Observations are available for years 1-173 (1850-2022)
hadcrut_file <- system.file("data", "hadcrut5_annual.rds", package = "BFACT")
hadcrut5_annual <- readRDS(hadcrut_file)

nc_close(nc)
```

# Plot Example: Climate Models and Observations

```{r plot-climate-models}
par(mfrow = c(3, 1), mar = c(4, 4, 2, 1))
scenarios <- c("z126c", "z245c", "z585c")
titles <- c("SSP 1-2.6", "SSP 2-4.5", "SSP 5-8.5")

for (i in seq_along(scenarios)) {
  mat <- climate_models[[scenarios[i]]]
  matplot(1:nrow(mat), mat,
    type = "l", lty = 1, col = "black",
    xlab = "Year", ylab = "Value", main = titles[i]
  )
  # Add hadcrut5_annual as red dots for overlapping years
  n_hadcrut <- length(hadcrut5_annual)
  points(1:n_hadcrut, hadcrut5_annual, col = "red", pch = 16, cex = 0.5)
  legend("topright",
    legend = c("Climate Models", "HadCRUT5 Observations"),
    col = c("black", "red"), lty = c(1, NA), pch = c(NA, 16), cex = 0.5, bty = "n"
  )
}
```

# Running the Algorithm

```{r run-algorithm}
results <- list()
for (i in seq_along(scenarios)) {
  B <- BFACT(
    Y = climate_models[[i]], z = hadcrut5_annual,
    T = 251, T1 = 1, T2 = 173,
    H = 2, iseed = 1, J = 6, nsim = 100
  )
  results[[scenarios[i]]] <- B
}
```

# View Results

```{r plot-results}
for (i in seq_along(scenarios)) {
  mat <- climate_models[[scenarios[i]]]
  matplot(1:nrow(mat), mat,
    type = "l", lty = 1, col = "black",
    xlab = "Year", ylab = "Value", main = titles[i]
  )
  # Add hadcrut5_annual as red dots for overlapping years
  n_hadcrut <- length(hadcrut5_annual)
  points(1:n_hadcrut, hadcrut5_annual, col = "red", pch = 16, cex = 0.5)
  # Add posterior curves
  post <- sample_posterior(results[[scenarios[i]]])
  matlines(1:ncol(post), t(post), col = "blue")
  legend("topright",
    legend = c("Climate Models", "HadCRUT5 Observations", "Posterior Samples"),
    col = c("black", "red", "blue"), lty = c(1, NA, 1), pch = c(NA, 16, NA), cex = 0.5, bty = "n"
  )
}
```

# Simulate a new set of model and observational data
```{r simulate-data}
sim <- simulate_from_posterior(results[["z245c"]])
matplot(1:nrow(sim$Y), sim$Y,
  type = "l", lty = 1, col = "black",
  xlab = "Year", ylab = "Value", main = titles[i]
)
# Add hadcrut5_annual as red dots for overlapping years
n_hadcrut <- length(sim$y_obs_full)
points(1:n_hadcrut, sim$y_obs_full, col = "red", pch = 16, cex = 0.5)
# Add posterior curves
matlines(1:nrow(sim$mu), sim$mu[, 1], col = "blue")
legend("topright",
  legend = c("Simulated Climate Models", "Simulated Observations", "Observation Signal"),
  col = c("black", "red", "blue"), lty = c(1, NA, 1), pch = c(NA, 16, NA), cex = 0.5, bty = "n"
)
```