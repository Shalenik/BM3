---
title: "Generate Publication Plots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{03-generate-plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    eval = FALSE,
    message = TRUE,
    warning = FALSE
)
```

# Generate Publication Plots

This vignette demonstrates creating publication-ready figures from consolidated BFACT results.

## Overview

Generate three main types of plots:

1. **Real data fits**: Posterior predictions with observations
2. **Model comparison**: DIC/RMSE across H values
3. **Posterior simulation results**: Model recovery assessment

## Generate Consolidated Results (Required)

Before plotting, generate and save consolidated results. The example below builds results for SSP5-8.5 using the New York data included with the package.

```{r generate-consolidated}
library(BFACT)
library(ncdf4)

# Load NetCDF file containing New York temperature anomalies
nc_file <- system.file("data", "NewYork_temperature_anomalies_JJA_all_models_1961-1990baseline.nc", package = "BFACT")
nc <- nc_open(nc_file)

# Extract temperature data: dimensions are [lon, lat, year, scenario, model]
temp_data <- ncvar_get(nc, "temperature")
years <- ncvar_get(nc, "year")

# Spatially average across lon and lat for each year, scenario, and model
# Result: [year, scenario, model] = [251, 3, 22]
temp_avg <- apply(temp_data, c(3, 4, 5), mean, na.rm = TRUE)

# Extract data for each SSP scenario
# Scenarios: 1=SSP1-2.6, 2=SSP2-4.5, 3=SSP5-8.5
climate_models <- list(
    z126c = temp_avg[, 1, ],
    z245c = temp_avg[, 2, ],
    z585c = temp_avg[, 3, ]
)

# Observations are available for years 1-173 (1850-2022)
hadcrut_file <- system.file("data", "hadcrut5_annual.rds", package = "BFACT")
hadcrut5_annual <- readRDS(hadcrut_file)

nc_close(nc)

scenario <- "ssp585_real"
region <- "New_York"
out_dir <- file.path("results", scenario, region)
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

Y <- climate_models$z585c
z <- hadcrut5_annual

sim <- list(
    Y = Y,
    z = z,
    years = years,
    T1 = 1,
    T2 = length(z)
)

H_values <- 2:3
fits <- lapply(H_values, function(H) {
    BM3(
        Y = Y,
        z = z,
        T = nrow(Y),
        T1 = 1,
        T2 = length(z),
        H = H,
        iseed = 100 + H,
        J = 6,
        nsim = 200
    )
})
names(fits) <- as.character(H_values)

consolidated <- consolidate_results(fits, sim)
```

## Plot 1: Real Data Fits by Region

```{r plot-real-fits}
library(ggplot2)
library(dplyr)

# Create faceted plot showing all H values
p_real_fits <- plot_timewise(consolidated, sim) +
    facet_wrap(~H_fit, ncol = 2) +
    labs(
        title = "BFACT Posterior Fits: New York (SSP585)",
        subtitle = "Red points: HadCRUT5 observations",
        x = "Year",
        y = "Temperature Anomaly (°C)"
    ) +
    theme(
        strip.text = element_text(face = "bold", size = 11),
        plot.subtitle = element_text(size = 10, color = "gray40")
    )

print(p_real_fits)
```

## Plot 2: Model Comparison Grid

```{r plot-model-comparison}
# Compare multiple regions/scenarios
scenarios <- c("ssp126_real", "ssp245_real", "ssp585_real")
regions <- c("New_York")

comparison_all <- expand.grid(scenario = scenarios, region = regions) %>%
    as_tibble() %>%
    mutate(
        results = pmap(list(scenario, region), function(s, r) {
            path <- sprintf("results/%s/%s/consolidated_results.rds", s, r)
            if (file.exists(path)) readRDS(path)$model_comparison else NULL
        }),
        label = sprintf(
            "%s\n%s",
            gsub("_real", "", scenario),
            gsub("_", " ", region)
        )
    ) %>%
    filter(!map_lgl(results, is.null)) %>%
    unnest(results)

p_comparison <- ggplot(comparison_all, aes(x = H, y = RMSE, color = label)) +
    geom_point(size = 2.5) +
    geom_line(linewidth = 0.6) +
    facet_wrap(~label, ncol = 3) +
    theme_minimal() +
    labs(
        title = "Model Selection Across Regions and Scenarios",
        x = "Number of Latent Factors (H)",
        y = "RMSE (lower = better)"
    ) +
    theme(
        legend.position = "none",
        strip.text = element_text(face = "bold"),
        panel.grid.minor = element_blank()
    )

ggsave(
    "results/figures/02_model_comparison.png",
    p_comparison,
    width = 14, height = 10, dpi = 300
)

print(p_comparison)
```

## Plot 3: RMSE Landscape

```{r plot-dic-landscape}
# Show RMSE as function of H for all combinations
comparison_all_expanded <- comparison_all %>%
    mutate(
        scenario_label = gsub("_real", "", scenario),
        region_label = gsub("_", " ", region)
    )

p_dic <- ggplot(
    comparison_all_expanded,
    aes(x = H, y = RMSE, fill = scenario_label)
) +
    geom_area(alpha = 0.4, position = "identity") +
    geom_line(aes(color = scenario_label), linewidth = 0.8) +
    facet_wrap(~region_label, scales = "free_y", ncol = 1) +
    theme_minimal() +
    labs(
        title = "RMSE Landscape: Optimal H Selection",
        x = "Number of Latent Factors (H)",
        y = "RMSE",
        fill = "Scenario",
        color = "Scenario"
    ) +
    scale_x_continuous(breaks = 2:7) +
    theme(
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 12)
    )

print(p_dic)
```

## Plot 4: Posterior Simulation Model Recovery

```{r plot-model-recovery}
# Load posterior simulation results
h_true_vals <- c(2, 4, 7)
recovery_results <- expand_grid(
    H_true = h_true_vals,
    location = c("GOM", "NY")
) %>%
    mutate(
        results = pmap(list(H_true, location), function(ht, loc) {
            path <- sprintf(
                "results/sim_posterior_%s/585/Htrue_%d/rep_001/consolidated.rds",
                loc, ht
            )
            if (file.exists(path)) {
                cons <- readRDS(path)
                cons$model_comparison %>%
                    mutate(H_true = ht, location = loc)
            } else {
                NULL
            }
        })
    ) %>%
    filter(!map_lgl(results, is.null)) %>%
    unnest(results)

# Plot: RMSE vs fitted H, colored by true H
p_recovery <- ggplot(recovery_results, aes(x = H, y = RMSE, color = factor(H_true))) +
    geom_point(size = 2.5, alpha = 0.7) +
    geom_line(linewidth = 0.6) +
    facet_wrap(~location, ncol = 1) +
    geom_vline(aes(xintercept = H_true, color = factor(H_true)),
        linetype = "dashed", alpha = 0.5
    ) +
    theme_minimal() +
    labs(
        title = "Model Recovery: Can BFACT Identify True H?",
        x = "Fitted H",
        y = "RMSE",
        color = "True H",
        subtitle = "Dashed lines indicate true H value"
    ) +
    scale_color_brewer(palette = "Set1") +
    theme(
        legend.position = "right",
        strip.text = element_text(face = "bold", size = 12),
        panel.grid.minor = element_blank()
    )

ggsave(
    "results/figures/04_model_recovery.png",
    p_recovery,
    width = 10, height = 8, dpi = 300
)

print(p_recovery)
```

## Plot 5: Posterior Predictions with Uncertainty

```{r plot-posteriors-with-obs}
# Create a high-quality posterior plot for best H
results_best <- readRDS("results/ssp585_real/New_York/consolidated_results.rds")
sim_best <- readRDS("results/ssp585_real/New_York/sim.rds")

# Choose best H by RMSE
best_H <- results_best$model_comparison$H[which.min(results_best$model_comparison$RMSE)]

summaries_best <- results_best$timewise_summaries %>%
    filter(H_fit == best_H) %>%
    mutate(year = sim_best$years[time])

# Observations
obs_df <- tibble(
    year = sim_best$years[1:length(sim_best$z)],
    obs = sim_best$z,
    type = "Observations"
)

p_posterior_detailed <- ggplot(summaries_best) +
    # 95% CI
    geom_ribbon(
        aes(x = year, ymin = post_ci_lower, ymax = post_ci_upper),
        alpha = 0.3, fill = "steelblue", name = "95% CI"
    ) +
    # Posterior mean
    geom_line(
        aes(x = year, y = post_mean, color = "Posterior Mean"),
        linewidth = 1, alpha = 0.8
    ) +
    # Observations
    geom_point(
        data = obs_df,
        aes(x = year, y = obs, color = "Observations"),
        size = 1.5, alpha = 0.6
    ) +
    theme_minimal() +
    scale_color_manual(
        values = c("Posterior Mean" = "#1f77b4", "Observations" = "#ff7f0e")
    ) +
    labs(
        title = sprintf("BFACT Posterior Fit: New York (H=%d)", best_H),
        subtitle = sprintf(
            "RMSE: %.4f",
            unique(summaries_best$rmse)
        ),
        x = "Year",
        y = "Temperature Anomaly (°C)",
        color = "Series"
    ) +
    theme(
        legend.position = "bottom",
        plot.subtitle = element_text(size = 10, color = "gray40"),
        panel.grid.minor = element_blank()
    )

ggsave(
    "results/figures/05_posterior_best_fit.png",
    p_posterior_detailed,
    width = 12, height = 6, dpi = 300
)

print(p_posterior_detailed)
```

## Plot 6: Multi-Panel Summary Figure

```{r plot-summary-figure}
library(patchwork)

# Combine key plots into one summary figure
p_summary <- (
    plot_comparison(results_best) /
        plot_timewise(results_best, sim_best)
) +
    plot_layout(heights = c(1, 2)) +
    plot_annotation(
        title = "BFACT Model Selection and Posterior Fits",
        subtitle = "New York, SSP585 Scenario",
        theme = theme(
            plot.title = element_text(face = "bold", size = 16),
            plot.subtitle = element_text(size = 12, color = "gray40")
        )
    )

ggsave(
    "results/figures/06_summary_panel.png",
    p_summary,
    width = 14, height = 12, dpi = 300
)

print(p_summary)
```

## Output Directory Structure

```
results/figures/
├── 01_real_fits_GOM.png
├── 02_model_comparison.png
├── 03_dic_landscape.png
├── 04_model_recovery.png
├── 05_posterior_best_fit.png
├── 06_summary_panel.png
└── README.md  # Description of each figure
```

## Tips for Publication

**Resolution**: Use `dpi = 300` for print publications
**Size**: Adjust `width` and `height` based on journal requirements
**Fonts**: Ggplot2 uses default fonts; use `ggtext` or `showtext` for custom fonts
**Colors**: Use colorblind-friendly palettes from `RColorBrewer` or `viridis`
**Format**: Save as PNG for quick preview, PDF for printing

## Batch Generate All Plots

```{r batch-all-plots, eval=FALSE}
# Source this script to generate all plots at once
source("data-raw/generate_all_plots.R")
```

## Troubleshooting

**Legend overlaps plot**
```r
p + theme(legend.position = "bottom")  # or "top", "left", "right"
```

**Facets are too small**
```r
facet_wrap(~H_fit, ncol = 2, scales = "free_y")  # Adjust ncol
```

**Points/lines too faint**
```r
geom_point(size = 3, alpha = 0.8)  # Increase size and alpha
```

**Year axis crowded**
```r
scale_x_continuous(breaks = seq(1850, 2100, by = 50))  # Sparser breaks
```
